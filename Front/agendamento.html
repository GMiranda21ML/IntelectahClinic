<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Intelectah Clinic - Agendamento</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="./styles/styles.css" rel="stylesheet">
</head>
<body class="bg-light-custom">
    <!-- Navbar -->
    <nav class="navbar navbar-expand-lg navbar-custom">
        <div class="container">
            <a class="navbar-brand" href="dashboard.html">
                <i class="fas fa-heartbeat me-2"></i>Intelectah Clinic
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav me-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="dashboard.html">
                            <i class="fas fa-home me-1"></i>Dashboard
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="agendamentos.html">
                            <i class="fas fa-calendar-alt me-1"></i>Meus Agendamentos
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="perfil.html">
                            <i class="fas fa-user me-1"></i>Perfil
                        </a>
                    </li>
                </ul>
                <ul class="navbar-nav">
                    <li class="nav-item">
                        <a class="nav-link" href="#" onclick="logout()">
                            <i class="fas fa-sign-out-alt me-1"></i>Sair
                        </a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="container mt-4">
        <!-- Header -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="dashboard-card">
                    <div class="d-flex align-items-center">
                        <a href="dashboard.html" class="btn btn-outline-primary me-3">
                            <i class="fas fa-arrow-left"></i>
                        </a>
                        <div>
                            <h2 class="text-primary mb-1">Novo Agendamento</h2>
                            <p class="text-muted mb-0">Siga os passos para agendar sua <span id="tipoSelecionado">consulta ou exame</span></p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Progress Steps -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="dashboard-card">
                    <div class="d-flex justify-content-between align-items-center">
                        <div class="d-flex align-items-center">
                            <div class="step-indicator active">1</div>
                            <span class="step-label">Tipo</span>
                        </div>
                        <div class="d-flex align-items-center">
                            <div class="step-indicator">2</div>
                            <span class="step-label">Especialidade</span>
                        </div>
                        <div class="d-flex align-items-center">
                            <div class="step-indicator">3</div>
                            <span class="step-label">Local</span>
                        </div>
                        <div class="d-flex align-items-center">
                            <div class="step-indicator">4</div>
                            <span class="step-label">Data</span>
                        </div>
                        <div class="d-flex align-items-center">
                            <div class="step-indicator">5</div>
                            <span class="step-label">Horário</span>
                        </div>
                        <div class="d-flex align-items-center">
                            <div class="step-indicator">6</div>
                            <span class="step-label">Confirmação</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Step 1: Tipo de Serviço -->
        <div class="row mb-4" id="tipoStep">
            <div class="col-12">
                <div class="dashboard-card">
                    <h4 class="text-primary mb-4">
                        <i class="fas fa-clipboard-list me-2"></i>Selecione o tipo de serviço
                    </h4>
                    <div class="row">
                        <div class="col-md-4 mb-3">
                            <button class="btn btn-outline-primary w-100 p-4 tipo-btn" onclick="selecionarTipo('CONSULTA_MEDICA')">
                                <i class="fas fa-user-md mb-3" style="font-size: 2rem;"></i>
                                <h5>Consulta Médica</h5>
                                <p class="text-muted mb-0">Atendimento com especialistas</p>
                            </button>
                        </div>
                        <div class="col-md-4 mb-3">
                            <button class="btn btn-outline-primary w-100 p-4 tipo-btn" onclick="selecionarTipo('EXAME_LABORATORIAL')">
                                <i class="fas fa-flask mb-3" style="font-size: 2rem;"></i>
                                <h5>Exame Laboratorial</h5>
                                <p class="text-muted mb-0">Análises clínicas e laboratoriais</p>
                            </button>
                        </div>
                        <div class="col-md-4 mb-3">
                            <button class="btn btn-outline-primary w-100 p-4 tipo-btn"  onclick="selecionarTipo('EXAME_IMAGEM')">
                                <i class="fas fa-x-ray mb-3" style="font-size: 2rem;"></i>
                                <h5>Exame de Imagem</h5>
                                <p class="text-muted mb-0">Raio-X, ultrassom, tomografia</p>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Step 2: Especialidade -->
        <div class="row mb-4" id="especialidadeStep" style="display: none;">
            <div class="col-12">
                <div class="dashboard-card">
                    <h4 class="text-primary mb-4">
                        <i class="fas fa-search me-2"></i>Escolha a especialidade
                    </h4>
                    
                    <!-- Campo de busca -->
                    <div class="mb-4">
                        <div class="input-group">
                            <span class="input-group-text">
                                <i class="fas fa-search"></i>
                            </span>
                            <input type="text" class="form-control form-control-lg" 
                                   id="buscaEspecialidade" 
                                   placeholder="Digite para buscar uma especialidade..."
                                   onkeyup="filtrarEspecialidades()">
                        </div>
                    </div>
                    
                    <div class="row" id="especialidadesContainer">
                        <!-- Especialidades serão carregadas via JavaScript -->
                    </div>
                    
                    <div class="mt-3">
                        <p class="text-muted">
                            <i class="fas fa-info-circle me-2"></i>
                            Especialidade selecionada: <strong id="especialidadeSelecionada">Nenhuma</strong>
                        </p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Step 3: Local/Unidade -->
        <div class="row mb-4" id="localStep" style="display: none;">
            <div class="col-12">
                <div class="dashboard-card">
                    <h4 class="text-primary mb-4">
                        <i class="fas fa-map-marker-alt me-2"></i>Escolha a unidade
                    </h4>
                    
                    <div class="row" id="unidadesContainer">
                        <!-- Unidades serão carregadas via JavaScript -->
                    </div>
                    
                    <div class="mt-3">
                        <p class="text-muted">
                            <i class="fas fa-info-circle me-2"></i>
                            Unidade selecionada: <strong id="unidadeSelecionada">Nenhuma</strong>
                        </p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Step 4: Data -->
        <div class="row mb-4" id="dataStep" style="display: none;">
            <div class="col-12">
                <div class="dashboard-card">
                    <h4 class="text-primary mb-4">
                        <i class="fas fa-calendar me-2"></i>Selecione a data
                    </h4>
                    
                    <div class="calendar-container">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h5 class="mb-0" id="mesAnoLabel"></h5>
                            <div class="d-flex gap-2">
                                <button class="btn btn-outline-primary btn-sm" onclick="mudarMes(-1)">
                                    <i class="fas fa-chevron-left"></i>
                                </button>
                                <button class="btn btn-outline-primary btn-sm" onclick="mudarMes(1)">
                                    <i class="fas fa-chevron-right"></i>
                                </button>
                            </div>
                        </div>

                        
                        <div class="row text-center mb-2">
                            <div class="col"><small class="text-muted">Dom</small></div>
                            <div class="col"><small class="text-muted">Seg</small></div>
                            <div class="col"><small class="text-muted">Ter</small></div>
                            <div class="col"><small class="text-muted">Qua</small></div>
                            <div class="col"><small class="text-muted">Qui</small></div>
                            <div class="col"><small class="text-muted">Sex</small></div>
                            <div class="col"><small class="text-muted">Sáb</small></div>
                        </div>
                        
                        <div class="d-flex flex-wrap justify-content-center" id="calendarioContainer">
                            <!-- Calendário será carregado via JavaScript -->
                        </div>
                        
                        <div class="mt-3 text-center">
                            <small class="text-muted">
                                <i class="fas fa-info-circle me-1"></i>
                                Finais de semana não disponíveis para agendamento
                            </small>
                        </div>
                    </div>
                    
                    <div class="mt-3">
                        <p class="text-muted">
                            <i class="fas fa-info-circle me-2"></i>
                            Data selecionada: <strong id="dataSelecionada">Nenhuma</strong>
                        </p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Step 5: Horário -->
        <div class="row mb-4" id="horarioStep" style="display: none;">
            <div class="col-12">
                <div class="dashboard-card">
                    <h4 class="text-primary mb-4">
                        <i class="fas fa-clock me-2"></i>Selecione o horário
                    </h4>
                    
                    <div class="mb-3">
                        <h6 class="text-muted">Manhã</h6>
                        <div class="row" id="horariosContainer">
                            <!-- Horários serão carregados via JavaScript -->
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <h6 class="text-muted">Tarde</h6>
                        <!-- Horários da tarde serão incluídos no container acima -->
                    </div>
                    
                    <div class="mt-3">
                        <div class="d-flex gap-3">
                            <small class="text-muted">
                                <span class="horario-slot" style="display: inline-block; width: 20px; height: 20px; margin-right: 5px;"></span>
                                Disponível
                            </small>
                            <small class="text-muted">
                                <span class="horario-slot ocupado" style="display: inline-block; width: 20px; height: 20px; margin-right: 5px;"></span>
                                Ocupado
                            </small>
                            <small class="text-muted">
                                <span class="horario-slot selected" style="display: inline-block; width: 20px; height: 20px; margin-right: 5px;"></span>
                                Selecionado
                            </small>
                        </div>
                    </div>
                    
                    <div class="mt-3">
                        <p class="text-muted">
                            <i class="fas fa-info-circle me-2"></i>
                            Horário selecionado: <strong id="horarioSelecionado">Nenhum</strong>
                        </p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Step 6: Confirmação -->
        <div class="row mb-4" id="confirmacaoStep" style="display: none;">
            <div class="col-12">
                <div class="dashboard-card">
                    <h4 class="text-primary mb-4">
                        <i class="fas fa-check-circle me-2"></i>Confirme seu agendamento
                    </h4>
                    
                    <div class="row">
                        <div class="col-md-8">
                            <div class="border rounded-3 p-4 mb-4">
                                <h5 class="text-primary mb-3">Resumo do Agendamento</h5>
                                
                                <div class="row mb-3">
                                    <div class="col-sm-4">
                                        <strong>Tipo:</strong>
                                    </div>
                                    <div class="col-sm-8" id="resumoTipo">-</div>
                                </div>
                                
                                <div class="row mb-3">
                                    <div class="col-sm-4">
                                        <strong>Especialidade:</strong>
                                    </div>
                                    <div class="col-sm-8" id="resumoEspecialidade">-</div>
                                </div>
                                
                                <div class="row mb-3">
                                    <div class="col-sm-4">
                                        <strong>Data:</strong>
                                    </div>
                                    <div class="col-sm-8" id="resumoData">-</div>
                                </div>
                                
                                <div class="row mb-3">
                                    <div class="col-sm-4">
                                        <strong>Horário:</strong>
                                    </div>
                                    <div class="col-sm-8" id="resumoHorario">-</div>
                                </div>
                                
                                <div class="row mb-3">
                                    <div class="col-sm-4">
                                        <strong>Unidade:</strong>
                                    </div>
                                    <div class="col-sm-8" id="resumoUnidade">-</div>
                                </div>
                                
                                <div class="row mb-3">
                                    <div class="col-sm-4">
                                        <strong>Endereço:</strong>
                                    </div>
                                    <div class="col-sm-8" id="resumoEndereco">-</div>
                                </div>
                            </div>
                            
                            <div class="form-check mb-4">
                                <input class="form-check-input" type="checkbox" id="lembreteEmail">
                                <label class="form-check-label" for="lembreteEmail">
                                    <i class="fas fa-envelope me-2"></i>Receber lembrete por e-mail
                                </label>
                            </div>
                            
                            <div class="d-flex gap-3">
                                <button class="btn btn-success btn-lg" onclick="confirmarAgendamento()">
                                    <i class="fas fa-check me-2"></i>Confirmar Agendamento
                                </button>
                                <button class="btn btn-outline-secondary btn-lg" onclick="window.location.href='dashboard.html'">
                                    <i class="fas fa-times me-2"></i>Cancelar
                                </button>
                            </div>
                        </div>
                        
                        <div class="col-md-4">
                            <div class="bg-light-custom rounded-3 p-4">
                                <h6 class="text-primary mb-3">
                                    <i class="fas fa-info-circle me-2"></i>Informações Importantes
                                </h6>
                                
                                <ul class="list-unstyled">
                                    <li class="mb-2">
                                        <i class="fas fa-clock text-warning me-2"></i>
                                        Chegue 15 minutos antes
                                    </li>
                                    <li class="mb-2">
                                        <i class="fas fa-id-card text-info me-2"></i>
                                        Traga documento com foto
                                    </li>
                                    <li class="mb-2">
                                        <i class="fas fa-credit-card text-success me-2"></i>
                                        Carteirinha do convênio
                                    </li>
                                    <li class="mb-2">
                                        <i class="fas fa-mobile-alt text-primary me-2"></i>
                                        Confirmação por SMS
                                    </li>
                                </ul>
                                
                                <hr>
                                
                                <h6 class="text-primary mb-2">Precisa de ajuda?</h6>
                                <p class="text-muted mb-2">
                                    <i class="fas fa-phone me-2"></i>(11) 3333-4444
                                </p>
                                <p class="text-muted mb-0">
                                    <i class="fas fa-whatsapp me-2"></i>(11) 99999-9999
                                </p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        const API_BASE_URL = "http://localhost:5294/";

        let tipoSelecionado = null;
        let especialidadeSelecionada = null;
        let unidadeSelecionada = null;
        let dataSelecionada = null;
        let horarioSelecionado = null;

        let stepAtual = 0;
        const stepsIds = ["tipoStep", "especialidadeStep", "localStep", "dataStep", "horarioStep", "confirmacaoStep"];

        function mostrarStep(index) {
            stepsIds.forEach(id => document.getElementById(id).style.display = "none");

            document.getElementById(stepsIds[index]).style.display = "block";

            atualizarStep(index);

            stepAtual = index;
        }

        function atualizarStep(index) {
            const indicators = document.querySelectorAll(".step-indicator");
            indicators.forEach((el, i) => {
                if (i === index) {
                    el.classList.add("active");
                } else {
                    el.classList.remove("active");
                }
            });
        }

        async function selecionarTipo(tipoNome) {
            try {
                const response = await fetch(`${API_BASE_URL}Especialidade/tipos-servico`, { credentials: 'include' });

                if (!response.ok) {
                        setTimeout(() => {
                            window.location.href = 'index.html'; s
                        }, 2000);
                        return;
                } 

                const tipos = await response.json();
                tipoSelecionado = tipos.find(t => t.nome.toLowerCase() === tipoNome.toLowerCase());

                document.getElementById("tipoSelecionado").innerText = tipoNome.replace("_", " ");
                document.getElementById("resumoTipo").innerText = tipoNome.replace("_", " ");

                
                document.getElementById("tipoStep").style.display = "none";
                document.getElementById("especialidadeStep").style.display = "block";

                
                carregarEspecialidades(tipoSelecionado.id);

            } catch (error) {
                console.error("Erro ao selecionar tipo:", error);
            }
            mostrarStep(1);
        }


        async function carregarEspecialidades(tipoId) {
            try {
                const response = await fetch(`${API_BASE_URL}Especialidade?tipo=${tipoId}`, { credentials: 'include' });
                const especialidades = await response.json();

                const container = document.getElementById("especialidadesContainer");
                container.innerHTML = "";

                especialidades.forEach(e => {
                    const card = document.createElement("div");
                    card.className = "col-md-4 mb-3";
                    card.innerHTML = `
                        <button class="btn btn-outline-primary w-100 p-3" onclick="selecionarEspecialidade(${e.id}, '${e.nomeEspecialidade}')">
                            <i class="fas fa-stethoscope mb-2"></i>
                            <h6>${e.nomeEspecialidade}</h6>
                        </button>
                    `;
                    container.appendChild(card);
                });
            } catch (error) {
                console.error("Erro ao carregar especialidades:", error);
            }
        }

        function selecionarEspecialidade(id, nome) {
            especialidadeSelecionada = { id, nome };
            document.getElementById("especialidadeSelecionada").innerText = nome;
            document.getElementById("resumoEspecialidade").innerText = nome;

            document.getElementById("especialidadeStep").style.display = "none";
            document.getElementById("localStep").style.display = "block";

            carregarUnidades();
            mostrarStep(2);
        }


        async function carregarUnidades() {
            try {
                const response = await fetch(`${API_BASE_URL}Unidade`, { credentials: 'include' });
                const unidades = await response.json();

                const container = document.getElementById("unidadesContainer");
                container.innerHTML = "";

                unidades.forEach(u => {
                    const card = document.createElement("div");
                    card.className = "col-md-4 mb-3";
                    card.innerHTML = `
                        <button class="btn btn-outline-primary w-100 p-3" onclick="selecionarUnidade(${u.id}, '${u.nomeUnidade}', '${u.endereco}')">
                            <i class="fas fa-hospital mb-2"></i>
                            <h6>${u.nomeUnidade}</h6>
                            <small>${u.endereco}</small>
                        </button>
                    `;
                    container.appendChild(card);
                });
            } catch (error) {
                console.error("Erro ao carregar unidades:", error);
            }
        }

        function selecionarUnidade(id, nome, endereco) {
            unidadeSelecionada = { id, nome, endereco };
            document.getElementById("unidadeSelecionada").innerText = nome;
            document.getElementById("resumoUnidade").innerText = nome;
            document.getElementById("resumoEndereco").innerText = endereco;

            document.getElementById("localStep").style.display = "none";
            document.getElementById("dataStep").style.display = "block";

            carregarCalendario();
            mostrarStep(3);
        }

        let mesAtual = new Date().getMonth();
        let anoAtual = new Date().getFullYear();

        const nomesMeses = [
            "Janeiro", "Fevereiro", "Março", "Abril", "Maio", "Junho",
            "Julho", "Agosto", "Setembro", "Outubro", "Novembro", "Dezembro"
        ];

        function mudarMes(incremento) {
            mesAtual += incremento;
            if (mesAtual > 11) {
                mesAtual = 0;
                anoAtual++;
            } else if (mesAtual < 0) {
                mesAtual = 11;
                anoAtual--;
            }
            carregarCalendario();
        }


        function carregarCalendario() {
            const container = document.getElementById('calendarioContainer');
            const hoje = new Date();
            const ultimoDiaMes = new Date(anoAtual, mesAtual + 1, 0);

            document.getElementById("mesAnoLabel").innerText = `${nomesMeses[mesAtual]} ${anoAtual}`;

            container.innerHTML = '';

            for (let dia = 1; dia <= ultimoDiaMes.getDate(); dia++) {
                const data = new Date(anoAtual, mesAtual, dia);
                const isPassado = data < new Date(hoje.getFullYear(), hoje.getMonth(), hoje.getDate());
                const isFimSemana = data.getDay() === 0 || data.getDay() === 6;

                const dayElement = `
                    <div class="calendar-day ${isPassado || isFimSemana ? 'disabled' : ''}" 
                        onclick="${!isPassado && !isFimSemana ? `selecionarData(event, '${data.toISOString().split('T')[0]}')` : ''}">
                        ${dia}
                    </div>
                `;
                container.innerHTML += dayElement;
            }
        }


        function selecionarData(event, dataISO) {
            document.querySelectorAll('.calendar-day').forEach(day => day.classList.remove('selected'));
            event.target.classList.add('selected');

            dataSelecionada = dataISO;
            document.getElementById("dataSelecionada").innerText = new Date(dataISO).toLocaleDateString();
            document.getElementById("resumoData").innerText = new Date(dataISO).toLocaleDateString();

            document.getElementById("dataStep").style.display = "none";
            document.getElementById("horarioStep").style.display = "block";

            carregarHorarios();
            mostrarStep(4);
        }

        async function carregarHorarios() {
            try {
                const response = await fetch(`${API_BASE_URL}Agendamento/disponibilidade?unidadeId=${unidadeSelecionada.id}&especialidadeId=${especialidadeSelecionada.id}&data=${dataSelecionada}`, { credentials: 'include' });
                const horarios = await response.json();

                const container = document.getElementById("horariosContainer");
                container.innerHTML = "";

                horarios.forEach(h => {
                    const horaFormatada = new Date(h).toLocaleTimeString([], { hour: "2-digit", minute: "2-digit" });
                    const btn = document.createElement("button");
                    btn.className = "btn btn-outline-success m-2";
                    btn.innerText = horaFormatada;
                    btn.onclick = () => selecionarHorario(h, horaFormatada);
                    container.appendChild(btn);
                });
            } catch (error) {
                console.error("Erro ao carregar horários:", error);
            }
        }

        function selecionarHorario(dataHora, horaFormatada) {
            horarioSelecionado = dataHora;
            document.getElementById("horarioSelecionado").innerText = horaFormatada;
            document.getElementById("resumoHorario").innerText = horaFormatada;

            document.getElementById("horarioStep").style.display = "none";
            document.getElementById("confirmacaoStep").style.display = "block";
            mostrarStep(5);
        }


        async function confirmarAgendamento() {
            try {
                const dto = {
                    especialidadeId: especialidadeSelecionada.id,
                    unidadeId: unidadeSelecionada.id,
                    dataHora: horarioSelecionado,
                    status: 0,
                    observacoes: "Agendado pelo portal"
                };

                const response = await fetch(`${API_BASE_URL}Agendamento/agendar`, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    credentials: 'include',
                    body: JSON.stringify(dto)
                });

                if (response.ok) {
                    alert("✅ Agendamento confirmado com sucesso!");
                    window.location.href = "dashboard.html";
                } else {
                    const erro = await response.text();
                    alert("❌ Erro ao confirmar agendamento: " + erro);
                }
            } catch (error) {
                console.error("Erro ao confirmar agendamento:", error);
            }
        }

        document.querySelectorAll('.step-indicator').forEach((el, i) => {
            el.style.cursor = "pointer";
            el.addEventListener("click", () => {
                if (i <= stepAtual) {
                    mostrarStep(i);
                }
            });
        });


        function logout() {
            window.location.href = 'index.html';
        }
    </script>
    
    <style>
        .step-indicator {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--border-color);
            color: var(--text-muted);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            margin-right: 10px;
        }
        
        .step-indicator.active {
            background: var(--primary-color);
            color: white;
        }
        
        .step-label {
            font-weight: 500;
            color: var(--text-muted);
        }
        
        .tipo-btn {
            height: 200px;
            transition: all 0.3s ease;
        }
        
        .tipo-btn:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
        }
        
        .tipo-btn.active {
            background: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }
    </style>
</body>
</html>